{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Job Opportunities</h2>

    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <form method="get" class="row g-3">
                        <div class="col-md-4">
                            <label for="search" class="form-label">Search</label>
                            <input type="text" class="form-control" id="search" name="search" placeholder="Job title, keywords..." value="{{ request.GET.search|default:'' }}">
                        </div>
                        <div class="col-md-3">
                            <label for="location" class="form-label">Location</label>
                            <input type="text" class="form-control" id="location" name="location" placeholder="City, Country..." value="{{ request.GET.location|default:'' }}">
                        </div>
                        <div class="col-md-3">
                            <label for="job_type" class="form-label">Job Type</label>
                            <select class="form-select" id="job_type" name="job_type">
                                <option value="">All Types</option>
                                <option value="FULL_TIME" {% if request.GET.job_type == 'FULL_TIME' %}selected{% endif %}>Full-time</option>
                                <option value="PART_TIME" {% if request.GET.job_type == 'PART_TIME' %}selected{% endif %}>Part-time</option>
                                <option value="CONTRACT" {% if request.GET.job_type == 'CONTRACT' %}selected{% endif %}>Contract</option>
                                <option value="INTERNSHIP" {% if request.GET.job_type == 'INTERNSHIP' %}selected{% endif %}>Internship</option>
                                <option value="REMOTE" {% if request.GET.job_type == 'REMOTE' %}selected{% endif %}>Remote</option>
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">Search</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-3">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Filter Results</h5>
                </div>
                <div class="card-body">
                    <form method="get" id="filter-form">
                        <!-- Preserve search parameters -->
                        {% if request.GET.search %}
                            <input type="hidden" name="search" value="{{ request.GET.search }}">
                        {% endif %}
                        {% if request.GET.location %}
                            <input type="hidden" name="location" value="{{ request.GET.location }}">
                        {% endif %}
                        {% if request.GET.job_type %}
                            <input type="hidden" name="job_type" value="{{ request.GET.job_type }}">
                        {% endif %}

                        <div class="mb-3">
                            <h6>Experience Level</h6>
                            <div class="form-check">
                                <input class="form-check-input filter-checkbox" type="checkbox" name="experience_level" value="ENTRY" id="entry_level" {% if 'ENTRY' in experience_levels %}checked{% endif %}>
                                <label class="form-check-label" for="entry_level">
                                    Entry Level
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input filter-checkbox" type="checkbox" name="experience_level" value="MID" id="mid_level" {% if 'MID' in experience_levels %}checked{% endif %}>
                                <label class="form-check-label" for="mid_level">
                                    Mid Level
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input filter-checkbox" type="checkbox" name="experience_level" value="SENIOR" id="senior_level" {% if 'SENIOR' in experience_levels %}checked{% endif %}>
                                <label class="form-check-label" for="senior_level">
                                    Senior Level
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input filter-checkbox" type="checkbox" name="experience_level" value="EXECUTIVE" id="executive_level" {% if 'EXECUTIVE' in experience_levels %}checked{% endif %}>
                                <label class="form-check-label" for="executive_level">
                                    Executive Level
                                </label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <h6>Salary Range</h6>
                            <div class="range-slider">
                                <input type="range" class="form-range" id="salary-range" name="salary_min" min="0" max="200000" step="10000" value="{{ request.GET.salary_min|default:0 }}">
                                <div class="d-flex justify-content-between">
                                    <span>$0</span>
                                    <span>$200k+</span>
                                </div>
                                <div class="text-center mt-2">
                                    Minimum: $<span id="salary-value">{{ request.GET.salary_min|default:0 }}</span>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <h6>Posted Date</h6>
                            <div class="form-check">
                                <input class="form-check-input filter-radio" type="radio" name="posted_within" value="1" id="last_24h" {% if request.GET.posted_within == '1' %}checked{% endif %}>
                                <label class="form-check-label" for="last_24h">
                                    Last 24 hours
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input filter-radio" type="radio" name="posted_within" value="7" id="last_week" {% if request.GET.posted_within == '7' %}checked{% endif %}>
                                <label class="form-check-label" for="last_week">
                                    Last 7 days
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input filter-radio" type="radio" name="posted_within" value="30" id="last_month" {% if request.GET.posted_within == '30' %}checked{% endif %}>
                                <label class="form-check-label" for="last_month">
                                    Last 30 days
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input filter-radio" type="radio" name="posted_within" value="0" id="any_time" {% if not request.GET.posted_within or request.GET.posted_within == '0' %}checked{% endif %}>
                                <label class="form-check-label" for="any_time">
                                    Any time
                                </label>
                            </div>
                        </div>

                        {% if skills %}
                        <div class="mb-3">
                            <h6>Skills</h6>
                            <div class="skills-filter" style="max-height: 200px; overflow-y: auto;">
                                {% for skill in skills %}
                                    <div class="form-check">
                                        <input class="form-check-input filter-checkbox" type="checkbox" name="skill" value="{{ skill.id }}" id="skill_{{ skill.id }}" {% if skill.id|stringformat:"i" in selected_skills %}checked{% endif %}>
                                        <label class="form-check-label" for="skill_{{ skill.id }}">
                                            {{ skill.name }}
                                        </label>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">Apply Filters</button>
                            <a href="{% url 'job_list' %}" class="btn btn-outline-secondary">Clear All</a>
                        </div>
                    </form>
                </div>
            </div>

            {% if user.is_authenticated and user.is_candidate %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Recommended For You</h5>
                </div>
                <div class="card-body">
                    {% if recommended_jobs %}
                        <div class="list-group">
                            {% for job in recommended_jobs %}
                                <a href="{% url 'job_detail' job.id %}" class="list-group-item list-group-item-action">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">{{ job.title }}</h6>
                                        <small>{{ job.match_percentage }}% match</small>
                                    </div>
                                    <small>{{ job.company.name }} • {{ job.location }}</small>
                                </a>
                            {% endfor %}
                        </div>
                        <div class="mt-3 text-center">
                            <a href="{% url 'recommended_jobs' %}" class="btn btn-sm btn-outline-primary">View All</a>
                        </div>
                    {% else %}
                        <p class="text-muted">Complete your profile and add skills to get job recommendations.</p>
                        <div class="d-grid">
                            <a href="{% url 'edit_profile' %}" class="btn btn-sm btn-outline-primary">Complete Profile</a>
                        </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>

        <div class="col-md-9">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h5 class="mb-0">{{ jobs.paginator.count }} Jobs Found</h5>
                </div>
                <div class="d-flex align-items-center">
                    <label for="sort_by" class="me-2">Sort by:</label>
                    <select class="form-select form-select-sm" id="sort_by" name="sort_by" onchange="updateSort(this.value)">
                        <option value="relevance" {% if sort_by == 'relevance' %}selected{% endif %}>Relevance</option>
                        <option value="date" {% if sort_by == 'date' %}selected{% endif %}>Date (Newest)</option>
                        <option value="salary" {% if sort_by == 'salary' %}selected{% endif %}>Salary (Highest)</option>
                    </select>
                </div>
            </div>

            {% if jobs %}
                <div class="job-list">
                    {% for job in jobs %}
                        <div class="card mb-3 job-card">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-8">
                                        <h5 class="card-title">
                                            <a href="{% url 'job_detail' job.id %}" class="text-decoration-none">{{ job.title }}</a>
                                            {% if job.is_new %}
                                                <span class="badge bg-success ms-2">New</span>
                                            {% endif %}
                                        </h5>
                                        <h6 class="card-subtitle mb-2 text-muted">{{ job.company.name }} • {{ job.location }}</h6>
                                        <div class="mb-2">
                                            <span class="badge bg-info me-2">{{ job.get_job_type_display }}</span>
                                            <span class="badge bg-secondary me-2">{{ job.get_experience_level_display }}</span>
                                            {% if job.salary_min and job.salary_max %}
                                                <span class="badge bg-light text-dark">${{ job.salary_min|floatformat:0 }} - ${{ job.salary_max|floatformat:0 }}</span>
                                            {% endif %}
                                        </div>
                                        <p class="card-text text-truncate-3">{{ job.description|striptags|truncatewords:30 }}</p>

                                        {% if job.skills.all %}
                                            <div class="job-skills">
                                                {% for skill in job.skills.all|slice:":5" %}
                                                    <span class="badge bg-light text-dark me-1">{{ skill.name }}</span>
                                                {% endfor %}
                                                {% if job.skills.all|length > 5 %}
                                                    <span class="badge bg-light text-dark">+{{ job.skills.all|length|add:"-5" }}</span>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <div class="company-logo mb-3">
                                            {% if job.company.logo %}
                                                <img src="{{ job.company.logo.url }}" alt="{{ job.company.name }}" style="max-width: 80px; max-height: 40px;">
                                            {% endif %}
                                        </div>
                                        <small class="text-muted d-block mb-2">Posted {{ job.created_at|timesince }} ago</small>
                                        <a href="{% url 'job_detail' job.id %}" class="btn btn-outline-primary btn-sm">View Details</a>
                                        {% if user.is_authenticated and user.is_candidate %}
                                            {% if job.id in saved_jobs %}
                                                <a href="{% url 'unsave_job' job.id %}?next={{ request.get_full_path|urlencode }}" class="btn btn-sm btn-outline-secondary ms-1">
                                                    <i class="bi bi-bookmark-fill"></i>
                                                </a>
                                            {% else %}
                                                <a href="{% url 'save_job' job.id %}?next={{ request.get_full_path|urlencode }}" class="btn btn-sm btn-outline-secondary ms-1">
                                                    <i class="bi bi-bookmark"></i>
                                                </a>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}

                    {% if jobs.has_other_pages %}
                        <nav aria-label="Job pagination">
                            <ul class="pagination justify-content-center">
                                {% if jobs.has_previous %}
                                    <li class="page-item">
                                        <a class="page-link" href="?{% if request.GET %}{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}{% endif %}page=1" aria-label="First">
                                            <span aria-hidden="true">&laquo;&laquo;</span>
                                        </a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="?{% if request.GET %}{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}{% endif %}page={{ jobs.previous_page_number }}" aria-label="Previous">
                                            <span aria-hidden="true">&laquo;</span>
                                        </a>
                                    </li>
                                {% else %}
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#" aria-label="First">
                                            <span aria-hidden="true">&laquo;&laquo;</span>
                                        </a>
                                    </li>
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#" aria-label="Previous">
                                            <span aria-hidden="true">&laquo;</span>
                                        </a>
                                    </li>
                                {% endif %}

                                {% for i in jobs.paginator.page_range %}
                                    {% if jobs.number == i %}
                                        <li class="page-item active">
                                            <a class="page-link" href="#">{{ i }}</a>
                                        </li>
                                    {% elif i > jobs.number|add:'-3' and i < jobs.number|add:'3' %}
                                        <li class="page-item">
                                            <a class="page-link" href="?{% if request.GET %}{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}{% endif %}page={{ i }}">{{ i }}</a>
                                        </li>
                                    {% endif %}
                                {% endfor %}

                                {% if jobs.has_next %}
                                    <li class="page-item">
                                        <a class="page-link" href="?{% if request.GET %}{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}{% endif %}page={{ jobs.next_page_number }}" aria-label="Next">
                                            <span aria-hidden="true">&raquo;</span>
                                        </a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="?{% if request.GET %}{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}{% endif %}page={{ jobs.paginator.num_pages }}" aria-label="Last">
                                            <span aria-hidden="true">&raquo;&raquo;</span>
                                        </a>
                                    </li>
                                {% else %}
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#" aria-label="Next">
                                            <span aria-hidden="true">&raquo;</span>
                                        </a>
                                    </li>
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#" aria-label="Last">
                                            <span aria-hidden="true">&raquo;&raquo;</span>
                                        </a>
                                    </li>
                                {% endif %}
                            </ul>
                        </nav>
                    {% endif %}
                </div>
            {% else %}
                <div class="card">
                    <div class="card-body text-center py-5">
                        <h5>No jobs found matching your criteria</h5>
                        <p class="text-muted">Try adjusting your search filters or explore different keywords.</p>
                        <a href="{% url 'job_list' %}" class="btn btn-primary">View All Jobs</a>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

{% block javascript %}
<script>
    // Update salary range value display
    const salaryRange = document.getElementById('salary-range');
    const salaryValue = document.getElementById('salary-value');

    if (salaryRange) {
        salaryRange.addEventListener('input', function() {
            salaryValue.textContent = this.value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        });
    }

    // Auto-submit form when filter checkboxes change
    const filterCheckboxes = document.querySelectorAll('.filter-checkbox');
    const filterRadios = document.querySelectorAll('.filter-radio');

    filterCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            document.getElementById('filter-form').submit();
        });
    });

    filterRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            document.getElementById('filter-form').submit();
        });
    });

    // Update sort parameter and reload
    function updateSort(value) {
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.set('sort_by', value);
        window.location.search = urlParams.toString();
    }
</script>
{% endblock %}

{% endblock %}